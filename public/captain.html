<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Капитан</title>
  <link rel="stylesheet" href="/theme.css">
</head>
<body>
  <div class="wrap">
    <div class="brandbar">
      <div class="brand">
        <div class="title">Экран капитана</div>
      </div>
      <div class="row">
        <div class="pill">
          <span class="badge" id="connBadge">WebSocket: …</span>
        </div>
        <button id="btnLogout" class="btn small secondary" style="display:none; min-width:auto;">Выход</button>
      </div>
    </div>

    <!-- TEAM SELECT -->
    <div id="teamBlock" class="card">
      <div class="head">
        <h2>Выберите команду</h2>
        <span class="badge">Одно устройство = одна команда</span>
      </div>
      <div class="small">Для смены команды используйте "Выход" или обратитесь к администратору.</div>
      <div class="hr"></div>

      <select id="teamSelect">
        <option value="">-- Выберите --</option>
      </select>

      <div class="row" style="margin-top:12px;">
        <button id="btnPickTeam" class="btn ok">Подтвердить</button>
      </div>

      <div id="teamMsg" style="margin-top:10px;"></div>
    </div>

    <!-- WAIT -->
    <div id="waitBlock" class="card hidden">
      <div class="head">
        <h2>Ждите</h2>
        <span class="badge">Игра скоро начнётся</span>
      </div>
      <div class="qText">Ведущий покажет первый вопрос.</div>
    </div>

    <!-- BREAK/TABLE -->
    <div id="breakBlock" class="card hidden">
      <div class="head">
        <h2 id="breakTitle">Перерыв</h2>
        <span class="badge" id="breakBadge">Пауза</span>
      </div>
      <div id="breakHint" class="small"></div>

      <div id="breakTableWrap" class="hidden" style="margin-top:12px;">
        <div class="hr"></div>

        <div class="row" style="justify-content:space-between; gap:10px; align-items:center; margin:0 0 10px 0;">
          <h3 style="margin:0;">Таблица результатов</h3>
          <button id="btnOpenFullTable" class="btn small secondary">+/- (в новой вкладке)</button>
        </div>

        <table>
          <thead id="scoreHead"></thead>
          <tbody id="scoreBody"></tbody>
        </table>
      </div>
    </div>

    <!-- GAME -->
    <div id="gameBlock" class="hidden">
      <div class="grid two">
        <div class="card">
          <div class="head">
            <h2 id="phaseTitle">Вопрос</h2>
            <div class="timer">
              <div class="timerLabel">
                <div class="small">Осталось</div>
                <div class="small" id="timerHint">—</div>
              </div>
              <div class="timerCircle"><div class="t" id="timerValue">60</div></div>
            </div>
          </div>

          <img id="questionImg" class="qImage hidden" alt="Раздатка">
          <div id="questionText" class="qText"></div>

          <div id="correctArea" class="hidden" style="margin-top:12px;">
            <div class="hr"></div>
            <h3 style="margin:0 0 10px 0;">Ответ и комментарий</h3>
            <div id="correctText" class="qText"></div>
            <img id="commentImg" class="qImage hidden" alt="Картинка в комментарии" style="margin-top:10px;">
          </div>
        </div>

        <div class="card">
          <div class="head">
            <h2>Ответ</h2>
            <span class="badge" id="teamBadge">Команда: —</span>
          </div>

          <textarea id="answerInput" placeholder="Введите ответ..." disabled></textarea>

          <div class="row" style="margin-top:12px; justify-content:flex-end;">
            <button id="btnSendAnswer" class="btn ok" disabled>Отправить ответ</button>
          </div>

          <div id="answerMsg" style="margin-top:10px;"></div>

          <div class="small" style="margin-top:10px;">
            Enter — отправить (Shift+Enter — новая строка). Можно переотправлять до конца таймера.
          </div>
        </div>
      </div>
    </div>

    <!-- footer logos -->
    <div class="card" style="margin-top:14px; padding:10px;">
      <div class="row" style="justify-content:space-between; align-items:center; width:100%;">
        <div class="small">© Лига Естественного Интеллекта</div>
        <div class="row" style="gap:12px;">
          <img src="logo-profsouz.png" alt="logo" style="height:34px; opacity:.95">
          <img src="logo-gazprom.png" alt="logo" style="height:34px; opacity:.95">
        </div>
      </div>
    </div>
  </div>

  <script>
    const protocol = location.protocol === 'https:' ? 'wss' : 'ws';
    const ws = new WebSocket(`${protocol}://${location.host}/?role=captain`);

    const connBadge = document.getElementById('connBadge');
    const btnLogout = document.getElementById('btnLogout');

    const teamBlock = document.getElementById('teamBlock');
    const teamSelect = document.getElementById('teamSelect');
    const btnPickTeam = document.getElementById('btnPickTeam');
    const teamMsg = document.getElementById('teamMsg');

    const waitBlock = document.getElementById('waitBlock');

    const breakBlock = document.getElementById('breakBlock');
    const breakTitle = document.getElementById('breakTitle');
    const breakBadge = document.getElementById('breakBadge');
    const breakHint = document.getElementById('breakHint');
    const breakTableWrap = document.getElementById('breakTableWrap');
    const btnOpenFullTable = document.getElementById('btnOpenFullTable');

    const scoreHead = document.getElementById('scoreHead');
    const scoreBody = document.getElementById('scoreBody');

    const gameBlock = document.getElementById('gameBlock');
    const phaseTitle = document.getElementById('phaseTitle');
    const timerValue = document.getElementById('timerValue');
    const timerHint = document.getElementById('timerHint');

    const questionImg = document.getElementById('questionImg');
    const questionText = document.getElementById('questionText');

    const correctArea = document.getElementById('correctArea');
    const correctText = document.getElementById('correctText');
    const commentImg = document.getElementById('commentImg');

    const teamBadge = document.getElementById('teamBadge');
    const answerInput = document.getElementById('answerInput');
    const btnSendAnswer = document.getElementById('btnSendAnswer');
    const answerMsg = document.getElementById('answerMsg');

    let teams = [];
    let myTeamId = null;

    let shown = { phase: 'waiting' };
    let timer = { running: false, remainingSec: 60 };

    let lastQuestionIndex = null;
    let hasSentThisQuestion = false;

    let lastTable = null;

    function escapeHtml(s) {
      return String(s ?? '').replace(/[&<>"']/g, ch => ({
        '&': '&amp;',
        '<': '&lt;',
        '>': '&gt;',
        '"': '&quot;',
        "'": '&#39;'
      })[ch]);
    }

    function setVisible(el, on) {
      el.classList.toggle('hidden', !on);
    }

    function setAnswerEnabled(on) {
      answerInput.disabled = !on;
      btnSendAnswer.disabled = !on;
      
      if (!on) {
        answerInput.placeholder = 'ожидайте';
        answerInput.style.color = '#888';
        answerInput.style.backgroundColor = '#e0e0e0';
        btnSendAnswer.style.opacity = '0.5';
        btnSendAnswer.style.backgroundColor = '#cccccc';
        btnSendAnswer.style.cursor = 'not-allowed';
      } else {
        answerInput.placeholder = 'Введите ответ...';
        answerInput.style.color = '';
        answerInput.style.backgroundColor = '';
        btnSendAnswer.style.opacity = '';
        btnSendAnswer.style.backgroundColor = '';
        btnSendAnswer.style.cursor = '';
      }
    }

    function getOrCreateDeviceId() {
      const key = 'chgkdeviceid';
      let id = localStorage.getItem(key);
      if (id) return id;
      const arr = new Uint8Array(16);
      crypto.getRandomValues(arr);
      id = Array.from(arr).map(b => b.toString(16).padStart(2, '0')).join('');
      localStorage.setItem(key, id);
      return id;
    }
    const deviceId = getOrCreateDeviceId();

    function send(type, payload) {
      if (ws.readyState !== WebSocket.OPEN) return;
      ws.send(JSON.stringify({ type, payload }));
    }

    function renderTeams() {
      const prev = teamSelect.value;

      teamSelect.innerHTML = '<option value="">-- Выберите --</option>';
      (teams || []).forEach(t => {
        const opt = document.createElement('option');
        opt.value = String(t.id);
        opt.textContent = t.name + (t.activeCaptain ? ' (занято)' : '');
        teamSelect.appendChild(opt);
      });

      if (prev) teamSelect.value = prev;

      const t = (teams || []).find(x => x.id === myTeamId);
      teamBadge.textContent = t ? `Команда: ${t.name}` : 'Команда: —';
    }

    // КОМПАКТНАЯ ТАБЛИЦА: только итог
    function renderTableCompact() {
      if (!lastTable) return;

      scoreHead.innerHTML = '<tr><th>Команда</th><th>Очки</th></tr>';
      scoreBody.innerHTML = '';

      (lastTable.rows || []).forEach(r => {
        const tr = document.createElement('tr');
        tr.innerHTML = `<td>${escapeHtml(r.name)}</td><td>${r.total ?? 0}</td>`;
        scoreBody.appendChild(tr);
      });
    }

    // ПОЛНАЯ ТАБЛИЦА (+/-) — новая вкладка/окно
    function openFullTableWindow() {
      if (!lastTable) return;

      const qCount = lastTable.questionsCount ?? 0;

      const headCells = ['#', 'Команда']
        .concat(Array.from({ length: qCount }, (_, i) => String(i + 1)))
        .concat(['Итог'])
        .map(x => `<th>${x}</th>`)
        .join('');

      const bodyRows = (lastTable.rows || []).map((r, idx) => {
        const per = Array.isArray(r.perQuestion) ? r.perQuestion : [];
        const cells = [];
        cells.push(`<td>${idx + 1}</td>`);
        cells.push(`<td style="white-space:nowrap">${escapeHtml(r.name)}</td>`);
        for (let i = 0; i < qCount; i++) {
          const v = per[i];
          const s = v === true ? '+' : (v === false ? '−' : '');
          cells.push(`<td style="text-align:center">${s}</td>`);
        }
        cells.push(`<td style="text-align:center; font-weight:900">${r.total ?? 0}</td>`);
        return `<tr>${cells.join('')}</tr>`;
      }).join('');

      const html = `<!doctype html>
<html lang="ru">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>Таблица (+/-)</title>
<style>
  body{font-family:system-ui,-apple-system,Segoe UI,Roboto,Arial; margin:14px; background:#07142a; color:#eaf2ff;}
  .hint{opacity:.8; margin:0 0 10px 0;}
  .wrap{overflow:auto; border:1px solid rgba(255,255,255,.18); border-radius:12px; background:rgba(0,25,55,.25);}
  table{border-collapse:collapse; min-width:max-content; width:100%;}
  th,td{border-bottom:1px solid rgba(255,255,255,.12); padding:10px 12px;}
  
  /* НЕПРОЗРАЧНЫЕ ЗАГОЛОВКИ */
  th{position:sticky; top:0; background:#07142a !important; text-align:center;}
  
  /* НЕПРОЗРАЧНЫЕ ПЕРВЫЕ ДВА СТОЛБЦА */
  td:first-child, th:first-child{
    position:sticky; left:0; background:#07142a !important;
    border-right: 1px solid rgba(255,255,255,.15);
  }
  td:nth-child(2), th:nth-child(2){
    position:sticky; left:52px; background:#07142a !important;
    border-right: 1px solid rgba(255,255,255,.15);
  }
  
  /* Заголовки первых двух колонок тоже непрозрачны */
  th:first-child, th:nth-child(2) {
    z-index: 10;
    background: #0a1e3d !important; /* Немного светлее для выделения */
  }
</style>
</head>
<body>
  <p class="hint">Поверните экран горизонтально и масштабируйте как удобно.</p>
  <div class="wrap">
    <table>
      <thead><tr>${headCells}</tr></thead>
      <tbody>${bodyRows}</tbody>
    </table>
  </div>
</body>
</html>`;

      const w = window.open('', '_blank');
      if (!w) return;
      w.document.open();
      w.document.write(html);
      w.document.close();
    }
    btnOpenFullTable.onclick = openFullTableWindow;

    function renderAll() {
      if (!myTeamId) {
        setVisible(teamBlock, true);
        setVisible(waitBlock, false);
        setVisible(breakBlock, false);
        setVisible(gameBlock, false);
        btnLogout.style.display = 'none';
        return;
      }

      btnLogout.style.display = 'inline-flex';

      if (!shown || shown.phase === 'waiting') {
        setVisible(teamBlock, false);
        setVisible(waitBlock, true);
        setVisible(breakBlock, false);
        setVisible(gameBlock, false);
        return;
      }

      if (shown.phase === 'break' || shown.phase === 'table') {
        setVisible(teamBlock, false);
        setVisible(waitBlock, false);
        setVisible(breakBlock, true);
        setVisible(gameBlock, false);

        if (shown.phase === 'break') {
          breakTitle.textContent = 'Перерыв';
          breakBadge.textContent = 'Пауза';
          breakHint.textContent = 'Ждите продолжения игры.';
          setVisible(breakTableWrap, false);
        } else {
          breakTitle.textContent = 'Таблица результатов';
          breakBadge.textContent = 'Очки';
          breakHint.textContent = 'Кнопка "+/-" откроет подробную таблицу в новой вкладке.';
          setVisible(breakTableWrap, true);
          renderTableCompact();
        }
        return;
      }

      // game screen
      setVisible(teamBlock, false);
      setVisible(waitBlock, false);
      setVisible(breakBlock, false);
      setVisible(gameBlock, true);

      timerValue.textContent = timer.remainingSec ?? 60;
      timerHint.textContent = timer.running ? 'Идёт отсчёт' : 'Пауза';

      const n = (shown.qIndex ?? 0) + 1;

      questionImg.src = shown.handoutImage;
      setVisible(questionImg, !!shown.handoutImage);

      commentImg.src = shown.commentImage;
      setVisible(commentImg, !!shown.commentImage);

      if (shown.phase === 'question') {
        if (lastQuestionIndex !== shown.qIndex) {
          lastQuestionIndex = shown.qIndex;
          hasSentThisQuestion = false;
          answerInput.value = '';
          answerMsg.innerHTML = '';
        }

        phaseTitle.textContent = `Вопрос ${n}`;
        questionText.textContent = shown.questionText || '';
        setVisible(correctArea, false);

        // ЕСЛИ ТАЙМЕР НЕ ИДЁТ - "ОЖИДАЙТЕ" в placeholder
        setAnswerEnabled(timer.running);
        if (!timer.running) {
          timerHint.textContent = 'Ждите запуска таймера';
        }
        return;
      }

      if (shown.phase === 'answer') {
        phaseTitle.textContent = `Ответ ${n}`;
        questionText.textContent = shown.questionText || '';
        setVisible(correctArea, true);

        const a = shown.answerText || '';
        const c = shown.commentText || '';
        correctText.textContent = c ? `${a}\n\n${c}` : a;

        setAnswerEnabled(false);
        answerInput.value = '';
        answerMsg.innerHTML = '';
        return;
      }
    }

    function sendAnswer(manual) {
      if (!myTeamId) return;
      if (!shown || shown.phase !== 'question') return;

      const text = (answerInput.value || '').trim();

      // Если пользователь не ввел ответ и это ручная отправка
      if (manual && !text) {
        answerMsg.innerHTML = '<div class="msg err">Введите ответ.</div>';
        return;
      }

      if (manual && !timer.running) {
        answerMsg.innerHTML = '<div class="msg err">Нельзя отправить: таймер не запущен.</div>';
        return;
      }

      if (!manual && hasSentThisQuestion) return;

      // Отправляем ответ (может быть пустым при автоотправке)
      send('captain_send_answer', { text });
      hasSentThisQuestion = true;
      
      // ОЧИСТКА ПОЛЯ ВВОДА ПОСЛЕ ОТПРАВКИ
      answerInput.value = '';

      const shownText = text ? escapeHtml(text) : '(пусто)';
      answerMsg.innerHTML = `<div class="msg ok">Отправлено: ${shownText}</div>`;
    }

    ws.onopen = () => {
      connBadge.textContent = 'Соединение: подключено';
      send('captain_hello', { deviceId });
    };
    ws.onerror = () => connBadge.textContent = 'Соединение: ошибка';
    ws.onclose = () => connBadge.textContent = 'Соединение: отключено';

    ws.onmessage = (event) => {
      let msg;
      try { msg = JSON.parse(event.data); } catch { return; }
      const { type, payload } = msg || {};

      if (type === 'init_for_captain') {
        teams = payload?.teams || [];
        shown = payload?.shown || { phase: 'waiting' };
        timer = payload?.timer || { running:false, remainingSec:60 };
        renderTeams();
        renderAll();
        return;
      }

      if (type === 'captain_session') {
        const assigned = payload?.assignedTeamId;
        if (assigned) myTeamId = assigned;
        renderTeams();
        renderAll();
        return;
      }

      if (type === 'teams_update') {
        teams = payload?.teams || [];
        renderTeams();
        return;
      }

      if (type === 'team_confirmed') {
        myTeamId = payload?.teamId ?? null;
        teamMsg.innerHTML = '<div class="msg ok">Команда выбрана.</div>';
        renderTeams();
        renderAll();
        return;
      }

      if (type === 'captain_logged_out') {
        myTeamId = null;
        teamMsg.innerHTML = '<div class="msg ok">Вы вышли.</div>';
        renderTeams();
        renderAll();
        return;
      }

      if (type === 'shown_update') {
        shown = payload || { phase: 'waiting' };
        if (shown.phase === 'question' && lastQuestionIndex !== shown.qIndex) {
          hasSentThisQuestion = false;
          lastQuestionIndex = shown.qIndex;
          answerInput.value = '';
          answerMsg.innerHTML = '';
        }
        // ОЧИСТКА ПРИ ПОКАЗЕ ОТВЕТА
        if (shown.phase === 'answer') {
          answerInput.value = '';
          answerMsg.innerHTML = '';
        }
        renderAll();
        return;
      }

      if (type === 'timer_update') {
        timer = payload || { running:false, remainingSec:60 };

        // если на вопросе таймер остановился и дошёл до 0 — блокируем и автофиксируем отправку
        if (shown && shown.phase === 'question' && !timer.running && (timer.remainingSec === 0 || timer.remainingSec === '0')) {
          setAnswerEnabled(false);
          // Отправляем текущий ответ (даже если пустой)
          sendAnswer(false);
        }

        renderAll();
        return;
      }

      if (type === 'break_table') {
        lastTable = payload;
        if (shown && shown.phase === 'table') renderTableCompact();
        return;
      }

      if (type === 'team_kicked') {
        if (myTeamId === payload?.teamId) {
          myTeamId = null;
          teamMsg.innerHTML = '<div class="msg err">Администратор исключил Вас. Выберите команду заново.</div>';
          renderTeams();
          renderAll();
        }
        return;
      }

      if (type === 'error') {
        const m = payload?.message || 'Ошибка';
        teamMsg.innerHTML = `<div class="msg err">${escapeHtml(m)}</div>`;
        return;
      }

      if (type === 'answer_ok') {
        // Ответ успешно принят сервером
        answerMsg.innerHTML = '<div class="msg ok">Ответ получен сервером.</div>';
        return;
      }
    };

    btnPickTeam.onclick = () => {
      const id = Number(teamSelect.value);
      if (!id) {
        teamMsg.innerHTML = '<div class="msg err">Выберите команду.</div>';
        return;
      }
      send('captain_pick_team', { teamId: id });
    };

    btnLogout.onclick = () => {
      send('captain_logout', {});
    };

    btnSendAnswer.onclick = () => sendAnswer(true);

    answerInput.addEventListener('keydown', (e) => {
      if (e.key === 'Enter' && !e.shiftKey) {
        e.preventDefault();
        sendAnswer(true);
      }
    });
  </script>
</body>
</html>