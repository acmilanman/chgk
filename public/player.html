<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Основной кран</title>
  <link rel="stylesheet" href="/theme.css">
  <style>
    /* TV layout overrides */
    .tvWrap{
      max-width: 1400px;
      margin: 0 auto;
      padding: 22px 18px 28px;
    }
    .tvTop{
      display:flex;
      align-items:flex-start;
      justify-content:space-between;
      gap:14px;
      margin-bottom: 12px;
    }
    .tvMeta{
      display:flex;
      flex-direction:column;
      gap:6px;
    }
    .tvMeta .line{
      display:flex;
      gap:10px;
      flex-wrap:wrap;
      align-items:center;
    }
    .tvPhase{
      font-size: clamp(18px, 2.2vw, 28px);
      font-weight: 900;
      letter-spacing: .2px;
    }
    .tvCount{
      font-size: clamp(14px, 1.4vw, 18px);
      color: var(--muted);
    }
    .tvTimer{
      display:flex;
      align-items:center;
      gap:10px;
    }
    .tvTimerNum{
      width: 76px;
      height: 76px;
      border-radius: 999px;
      border: 2px solid rgba(193,240,251,.55);
      background:
        radial-gradient(circle at 35% 30%, rgba(193,240,251,.22), transparent 55%),
        rgba(0,30,70,.30);
      display:flex;
      align-items:center;
      justify-content:center;
      box-shadow: var(--shadow2);
      font-weight: 900;
      font-size: 28px;
    }
    .tvText{
      font-size: clamp(28px, 3.2vw, 54px);
      line-height: 1.18;
      white-space: pre-wrap;
    }
    .tvAnswer{
      margin-top: 14px;
      padding-top: 14px;
      border-top: 1px solid rgba(255,255,255,.14);
    }
    .tvAnswer .tvText{
      font-size: clamp(24px, 2.7vw, 46px);
    }
    .tvImg{
      width:100%;
      max-height: 46vh;
      object-fit: contain;
      border-radius: 14px;
      border:1px solid rgba(255,255,255,.18);
      background: rgba(0,25,55,.25);
      margin: 10px 0 12px;
    }

    /* Answer: center-only */
    .centerAnswer{
      border-top: none !important;
      margin-top: 0 !important;
      padding-top: 0 !important;
      min-height: 55vh;
      display: flex;
      align-items: center;
      justify-content: center;
    }
    .centerAnswer .tvText{
      text-align: center;
      font-weight: 900;
    }

    /* Table (+/-) */
    .tvTableWrap{
      margin-top: 10px;
      padding-top: 12px;
      border-top: 1px solid rgba(255,255,255,.14);
    }
    .tvTableScroll{
      overflow: auto;
      border-radius: 14px;
      border:1px solid rgba(255,255,255,.18);
      background: rgba(0,25,55,.25);
    }
    .tvScoreTable{
      border-collapse: collapse;
      width: 100%;
      min-width: max-content;
    }
    .tvScoreTable th,
    .tvScoreTable td{
      padding: 10px 12px;
      border-bottom: 1px solid rgba(255,255,255,.12);
      white-space: nowrap;
    }
    .tvScoreTable th{
      position: sticky;
      top: 0;
      background: rgba(7,20,42,.92);
      backdrop-filter: blur(6px);
      text-align: center;
      font-weight: 900;
    }
    .tvScoreTable td{ text-align: center; }
    .tvScoreTable td.tName{ text-align: left; font-weight: 700; }

    /* Sticky 1-2 columns */
    .tvScoreTable th.st0,
    .tvScoreTable td.st0{
      position: sticky;
      left: 0;
      background: rgba(7,20,42,.92);
      z-index: 2;
      text-align: left;
    }
    .tvScoreTable th.st1,
    .tvScoreTable td.st1{
      position: sticky;
      left: 52px;
      background: rgba(7,20,42,.92);
      z-index: 2;
      text-align: left;
    }
    .tvScoreTable th.st0{ z-index: 4; }
    .tvScoreTable th.st1{ z-index: 4; }

    .cornerLogos{
      position: fixed;
      right: 14px;
      bottom: 14px;
      z-index: 10;
      display:flex;
      gap:10px;
      align-items:center;
      padding: 8px 10px;
      border-radius: 14px;
      border:1px solid rgba(255,255,255,.18);
      background: rgba(0,25,55,.25);
      backdrop-filter: blur(6px);
    }
    .cornerLogos img{ height: 32px; opacity: .95; }
    .tvFooter{
      margin-top: 10px;
      color: var(--muted);
      font-size: 14px;
    }
  </style>
</head>
<body>
  <div class="tvWrap">
    <div class="tvTop">
      <div class="tvMeta">
        <div class="line">
          <div class="tvPhase" id="phaseTitle">Ждите</div>
          <div class="badge" id="connBadge">WebSocket: …</div>
        </div>
        <div class="tvCount" id="countTitle">—</div>
      </div>

      <div class="tvTimer" aria-label="Таймер">
        <div class="tvTimerNum" id="timerValue">60</div>
      </div>
    </div>

    <div class="card">
      <img id="questionImg" class="tvImg hidden" alt="Раздатка">
      <div id="questionText" class="tvText"></div>

      <div id="answerBlock" class="tvAnswer hidden">
        <div id="answerText" class="tvText"></div>
        <img id="commentImg" class="tvImg hidden" alt="Картинка в комментарии">
      </div>

      <div id="scoreWrap" class="tvTableWrap hidden">
        <div class="tvTableScroll">
          <table class="tvScoreTable">
            <thead id="scoreHead"></thead>
            <tbody id="scoreBody"></tbody>
          </table>
        </div>
      </div>
    </div>

    <div class="tvFooter">© Лига Естественного Интеллекта</div>
  </div>

  <!-- corner logos -->
  <div class="cornerLogos">
    <img src="/logo-profsouz.png" alt="Профсоюз">
    <img src="/logo-gazprom.png" alt="ПАО Газпром">
  </div>

  <script>
    const protocol = location.protocol === 'https:' ? 'wss' : 'ws';
    const ws = new WebSocket(`${protocol}://${location.host}/?role=player`);

    const connBadge = document.getElementById('connBadge');
    const phaseTitle = document.getElementById('phaseTitle');
    const countTitle = document.getElementById('countTitle');
    const timerValue = document.getElementById('timerValue');

    const questionImg = document.getElementById('questionImg');
    const questionText = document.getElementById('questionText');

    const answerBlock = document.getElementById('answerBlock');
    const answerText = document.getElementById('answerText');
    const commentImg = document.getElementById('commentImg');

    const scoreWrap = document.getElementById('scoreWrap');
    const scoreHead = document.getElementById('scoreHead');
    const scoreBody = document.getElementById('scoreBody');

    let shown = { phase: 'waiting' };
    let timer = { running: false, remainingSec: 60 };
    let totalQuestions = 0;

    let lastTable = null;

    function setVisible(el, on) {
      el.classList.toggle('hidden', !on);
    }

    function escapeHtml(s) {
      return String(s ?? '').replace(/[&<>"']/g, ch => ({
        '&': '&amp;',
        '<': '&lt;',
        '>': '&gt;',
        '"': '&quot;',
        "'": '&#39;'
      })[ch]);
    }

    function renderScoreTableFull() {
      if (!lastTable) return;

      const qCount = lastTable.questionsCount ?? 0;

      let h = '<tr>';
      h += '<th class="st0">#</th>';
      h += '<th class="st1">Команда</th>';
      for (let i = 0; i < qCount; i++) h += `<th>${i + 1}</th>`;
      h += '<th>Итог</th>';
      h += '</tr>';
      scoreHead.innerHTML = h;

      scoreBody.innerHTML = '';
      (lastTable.rows || []).forEach((r, idx) => {
        const tr = document.createElement('tr');

        let rowHtml = '';
        rowHtml += `<td class="st0">${idx + 1}</td>`;
        rowHtml += `<td class="st1 tName">${escapeHtml(r.name)}</td>`;

        const per = Array.isArray(r.perQuestion) ? r.perQuestion : [];
        for (let i = 0; i < qCount; i++) {
          const v = per[i];
          const s = v === true ? '+' : (v === false ? '−' : '');
          rowHtml += `<td>${s}</td>`;
        }

        rowHtml += `<td style="font-weight:900;">${r.total ?? 0}</td>`;

        tr.innerHTML = rowHtml;
        scoreBody.appendChild(tr);
      });
    }

    function renderAll() {
      timerValue.textContent = timer.remainingSec ?? 60;

      if (shown && (shown.phase === 'question' || shown.phase === 'answer')) {
        const n = (shown.qIndex ?? 0) + 1;
        const total = totalQuestions > 0 ? totalQuestions : '?';
        countTitle.textContent = `Вопрос ${n} из ${total}`;
      } else {
        countTitle.textContent = ' ';
      }

      setVisible(scoreWrap, false);
      answerBlock.classList.remove('centerAnswer');

      if (!shown || shown.phase === 'waiting') {
        phaseTitle.textContent = 'Ждите';
        questionText.textContent = 'Игра скоро начнётся.';
        setVisible(questionImg, false);
        setVisible(answerBlock, false);
        setVisible(commentImg, false);
        return;
      }

      if (shown.phase === 'break') {
        phaseTitle.textContent = 'Перерыв';
        questionText.textContent = 'Пауза.';
        setVisible(questionImg, false);
        setVisible(answerBlock, false);
        setVisible(commentImg, false);
        return;
      }

      if (shown.phase === 'table') {
        phaseTitle.textContent = 'Таблица результатов';
        questionText.textContent = '';
        setVisible(questionImg, false);
        setVisible(answerBlock, false);
        setVisible(commentImg, false);
        setVisible(scoreWrap, true);
        renderScoreTableFull();
        return;
      }

      const n = (shown.qIndex ?? 0) + 1;
      phaseTitle.textContent = shown.phase === 'question' ? `Вопрос ${n}` : `Ответ ${n}`;

      if (shown.phase === 'question') {
        questionImg.src = shown.handoutImage;
        setVisible(questionImg, !!shown.handoutImage);

        questionText.textContent = shown.questionText || '';
        setVisible(answerBlock, false);
        setVisible(commentImg, false);
        return;
      }

      if (shown.phase === 'answer') {
        setVisible(questionImg, false);
        questionText.textContent = '';

        setVisible(answerBlock, true);
        answerBlock.classList.add('centerAnswer');

        const a = shown.answerText || '';
        answerText.textContent = `${a}`;

        setVisible(commentImg, false);
        return;
      }
    }

    ws.onopen = () => connBadge.textContent = 'Соединение: подключено';
    ws.onerror = () => connBadge.textContent = 'Соединение: ошибка';
    ws.onclose = () => connBadge.textContent = 'Соединение: отключено';

    ws.onmessage = (event) => {
      let msg;
      try { msg = JSON.parse(event.data); } catch { return; }
      const { type, payload } = msg || {};

      if (type === 'init_for_player') {
        shown = payload?.shown || { phase: 'waiting' };
        timer = payload?.timer || { running: false, remainingSec: 60 };
        renderAll();
        return;
      }

      if (type === 'shown_update') {
        shown = payload || { phase: 'waiting' };
        renderAll();
        return;
      }

      if (type === 'timer_update') {
        timer = payload || { running: false, remainingSec: 60 };
        renderAll();
        return;
      }

      if (type === 'break_table') {
        lastTable = payload;
        totalQuestions = payload?.questionsCount || 0;
        if (shown && shown.phase === 'table') renderScoreTableFull();
        renderAll();
        return;
      }
    };
  </script>
</body>
</html>
